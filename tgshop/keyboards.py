from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from tgshop.models.categories import Category
from tgshop.models.product import Product
from django.shortcuts import get_object_or_404
#Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²
#Ğ”Ğ»Ñ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ°

__all__ = [
    'main_keyboard',
    'catalog_keyboard',
    'create_keyboard',
    'create_product_keyboard',
    'cancel_keyboard',
    'create_cart_keyboard',
    'create_cart_item_keyboard',
    'create_delivery_keyboard'  # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ
]

# Ğ¡Ğ²ĞµĞ¶Ğ°Ñ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ¼ĞµĞ½Ñ
categories_new = Category.objects.filter(parent__isnull=True).order_by('order')
updated_keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text=cat.name, callback_data=f"category_{cat.id}")] 
            for cat in categories_new
        ]
    )

# Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ°
main_keyboard = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³"), KeyboardButton(text="ĞšĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ°")],
        [KeyboardButton(text="ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ¸ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ°"), KeyboardButton(text="Ğ›Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚")],
        [KeyboardButton(text="Ğ¡Ğ²ÑĞ·ÑŒ Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼"), KeyboardButton(text="Ğ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğµ")],
    ],
    resize_keyboard=True
)

# Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ inline-ĞºĞ½Ğ¾Ğ¿ĞºĞ¸
categories = Category.objects.filter(parent__isnull=True).order_by('order')
catalog_keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text=cat.name, callback_data=f"category_{cat.id}")] for cat in categories
        ]
    )

def create_keyboard(category_id=None):
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ»Ñ ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº
    buttons = []
    
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ´ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸
    subcategories = Category.objects.filter(parent_id=category_id)
    products = Product.objects.filter(category_id=category_id)
    
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¿Ğ¾Ğ´ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¹
    for subcategory in subcategories:
        buttons.append([
            InlineKeyboardButton(
                text=subcategory.name,
                callback_data=f"category_{subcategory.id}"
            )
        ])
    
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²
    for product in products:
        buttons.append([
            InlineKeyboardButton(
                text=f"{product.name} - {product.price}â‚½",
                callback_data=f"product_{product.id}"
            )
        ])
    
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "ĞĞ°Ğ·Ğ°Ğ´"
    if category_id is not None:
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ
        current_category = Category.objects.get(id=category_id)
        # Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ñ€Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒÑĞºĞ°Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ÑÑ Ğº Ğ½ĞµĞ¹
        if current_category.parent_id:
            back_id = current_category.parent_id
        else:
            # Ğ•ÑĞ»Ğ¸ Ñ€Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒÑĞºĞ¾Ğ¹ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ Ğ½ĞµÑ‚, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ÑÑ Ğ² ĞºĞ¾Ñ€Ğ½ĞµĞ²Ğ¾Ğµ Ğ¼ĞµĞ½Ñ
            back_id = "main"
        
        buttons.append([
            InlineKeyboardButton(
                text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´",
                callback_data=f"category_{back_id}"
            )
        ])
    
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def create_product_keyboard(product_id: int) -> InlineKeyboardMarkup:
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ğ´Ğ»Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ›’ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñƒ", callback_data=f"add_to_cart_{product_id}")],
        [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data=f"back_to_category_{product_id}")]
    ])
    return keyboard

cancel_keyboard = ReplyKeyboardMarkup(
    keyboard=[[KeyboardButton(text="ĞÑ‚Ğ¼ĞµĞ½Ğ°")]],
    resize_keyboard=True
)

def create_cart_keyboard(cart_items):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹ Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñ‹"""
    keyboard = []
    
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°
    for item in cart_items:
        keyboard.append([
            InlineKeyboardButton(
                text=f"{item.product.name} ({item.quantity} ÑˆÑ‚.)", 
                callback_data=f"edit_cart_{item.id}"
            )
        ])
    
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ¾Ğ¹
    if cart_items:  # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹
        keyboard.extend([
            [InlineKeyboardButton(text="ğŸ—‘ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñƒ", callback_data="clear_cart")],
            [InlineKeyboardButton(text="âœ… ĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ·", callback_data="checkout")]
        ])
    
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

def create_cart_item_keyboard(item_id: int, quantity: int) -> InlineKeyboardMarkup:
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ° Ğ² ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ğµ"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="â–", callback_data=f"cart_decrease_{item_id}"),
            InlineKeyboardButton(text=f"{quantity}", callback_data="ignore"),
            InlineKeyboardButton(text="â•", callback_data=f"cart_increase_{item_id}")
        ],
        [InlineKeyboardButton(text="âŒ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ", callback_data=f"cart_remove_{item_id}")],
        [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´ Ğº ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ğµ", callback_data="back_to_cart")]
    ])
    return keyboard

def create_delivery_keyboard() -> InlineKeyboardMarkup:
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ° Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸšš ĞšÑƒÑ€ÑŒĞµÑ€Ğ¾Ğ¼", callback_data="delivery_courier")],
        [InlineKeyboardButton(text="ğŸª Ğ¡Ğ°Ğ¼Ğ¾Ğ²Ñ‹Ğ²Ğ¾Ğ·", callback_data="delivery_pickup")],
        [InlineKeyboardButton(text="âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°", callback_data="cancel_order")]
    ])
    return keyboard
